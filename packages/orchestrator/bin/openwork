#!/usr/bin/env node

const childProcess = require("child_process")
const os = require("os")
const path = require("path")

const warnedLegacyEnvKeys = new Set()

function readCompatEnv(openworkKey) {
  if (openworkKey.startsWith("OPENWORK_")) {
    const dowhatKey = `DOWHAT_${openworkKey.slice("OPENWORK_".length)}`
    const dowhatValue = process.env[dowhatKey]
    if (dowhatValue !== undefined) return dowhatValue
    const openworkValue = process.env[openworkKey]
    if (openworkValue !== undefined && !warnedLegacyEnvKeys.has(openworkKey)) {
      warnedLegacyEnvKeys.add(openworkKey)
      process.stderr.write(`[openwork] Deprecated env \"${openworkKey}\" detected; please migrate to \"${dowhatKey}\".\n`)
    }
    return openworkValue
  }
  return process.env[openworkKey]
}

function run(target) {
  const result = childProcess.spawnSync(target, process.argv.slice(2), {
    stdio: "inherit",
  })
  if (result.error) {
    console.error(result.error.message)
    process.exit(1)
  }
  const code = typeof result.status === "number" ? result.status : 0
  process.exit(code)
}

const envPath = readCompatEnv("OPENWORK_ORCHESTRATOR_BIN_PATH")
if (envPath) {
  run(envPath)
}

const platformMap = {
  darwin: "darwin",
  linux: "linux",
  win32: "windows",
}

const archMap = {
  x64: "x64",
  arm64: "arm64",
  arm: "arm",
}

let platform = platformMap[os.platform()]
if (!platform) {
  platform = os.platform()
}

let arch = archMap[os.arch()]
if (!arch) {
  arch = os.arch()
}

const pkg = `openwork-orchestrator-${platform}-${arch}`
const binary = platform === "windows" ? "openwork.exe" : "openwork"

let pkgJsonPath
try {
  pkgJsonPath = require.resolve(`${pkg}/package.json`)
} catch {
  console.error(
    `openwork: no prebuilt binary package found for ${platform}/${arch}.\n` +
      `Try installing the platform package manually: ${pkg}`,
  )
  process.exit(1)
}

const resolved = path.join(path.dirname(pkgJsonPath), "bin", binary)
run(resolved)
