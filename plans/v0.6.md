# v0.6 变更计划与执行记录

## 1. 背景

当前仓库存在三类问题：
1. 环境缺失导致桌面端安装/启动失败（bun、rust 等）
2. 文档仍保留旧叙事，与当前产品目标不一致
3. Router 相关依赖策略前后不一致，影响构建稳定性

## 2. v0.6 目标

1. 缺环境时可一键自动安装
2. 主链路安装和启动不依赖 Router
3. 文档统一到多运行时并列模型
4. 删除历史 PR 文档噪音
5. 建立长期维护规则（AGENTS + plans）

## 3. 范围

### In Scope

- Windows 自动化环境脚本
- sidecar/router 默认行为调整
- 核心文档重写
- `plans/history.md` 与 `AGENTS.md` 维护机制更新

### Out of Scope

- 全量品牌命名重构
- 新云端控制面实现
- 非 Windows 平台自动安装脚本

## 4. 实施清单

### 4.1 环境自动化

- `scripts/setup/windows/doctor.ps1`
- `scripts/setup/windows/install.ps1`
- `scripts/setup/windows/bootstrap.ps1`
- `package.json` scripts:
  - `doctor:windows`
  - `setup:windows`
  - `bootstrap:windows`
- Bun 安装增强：
  - `winget` 多策略重试（默认/指定源/用户域）
  - 失败后自动回退 Bun 官方安装脚本
- Rust 工具链增强：
  - `doctor` 增加 `rust-toolchain` 检查（避免 cargo shim 误判为可用）
  - `install` 自动执行 `rustup default stable` 并二次验证 `rustc/cargo`

### 4.2 Router 可选化

- `packages/desktop/scripts/prepare-sidecar.mjs`
  - 新增 `DOWHAT_ROUTER_ENABLED` 控制
  - 默认关闭 router
  - 未启用时不再要求本地 `packages/opencode-router`
- `packages/orchestrator/src/cli.ts`
  - Router 默认值改为关闭
- `packages/desktop/src-tauri/src/commands/orchestrator.rs`
  - 沙箱启动参数遵循 Router 开关

### 4.3 瘦身开发模式

- 根脚本已统一：
  - `dev` -> `dev:business`（默认业务主链路）
  - `dev:business` -> `@do-what/ui`
  - `dev:desktop` -> `@do-what/desktop`（完整 Tauri 桌面链路）
  - `dev:ui` 保留（指向 `@do-what/ui`）
  - `dev:lite` 保留为过渡别名（deprecated）
- 目的：先保证快速迭代，再处理桌面工具链问题

### 4.4 Windows linker 冲突修复

- `packages/desktop/scripts/dev.mjs` 自动探测 Visual Studio `link.exe`
- 注入 `CARGO_TARGET_X86_64_PC_WINDOWS_MSVC_LINKER`，规避 Git `link.exe` 抢占 PATH

### 4.3 文档重建

重写：
- `README.md`
- `PROJECT_FRAMEWORK.md`
- `ARCHITECTURE.md`
- `INFRASTRUCTURE.md`
- `packages/orchestrator/README.md`
- `packages/server/README.md`

新增：
- `docs/INSTALL_WINDOWS.md`
- `docs/STARTUP_GUIDE.md`
- `docs/TROUBLESHOOTING.md`
- `docs/CORE_LOGIC_AND_MODULES.md`
- `docs/RUNTIME_MATRIX.md`

### 4.4 历史噪音清理

- 删除 `packages/app/pr/` 目录

## 5. 验收标准

1. `doctor.ps1` 能识别当前缺失依赖
2. `prepare-sidecar.mjs` 在 Router 关闭时不因缺少本地 router 包失败
3. orchestrator 默认可在无 Router 条件下启动
4. README 和 docs 可独立指导新机器完成安装与启动
5. `AGENTS.md` 明确规定 plans/history 联动维护

## 6. 风险与回滚

### 风险

- 企业网络策略可能阻断 winget/npm 下载
- 用户本机权限不足可能导致部分安装失败
- `winget` 个别错误码（如 `-1978335189`）在特定环境会出现，已通过 Bun 回退安装缓解

### 回滚

- Router 行为可通过环境变量即时回切
- 文档变更不影响运行时行为，可独立回退

## 7. 持续维护规则（v0.6）

每次功能改动后必须同步：
1. `plans/v0.6.md`（记录当前迭代变化）
2. `plans/history.md`（更新版本级历史）
3. 受影响模块 README

## 8. v0.6 真瘦身专项

已新增专项规格文档：
- `plans/v0.6-slimming-spec.md`

专项目标：
1. 让“业务可运行”成为默认启动链路
2. 桌面壳与可选扩展能力后置
3. 建立 core/optional 模块分层，减少后续改造成本

## 9. 实施记录（2026-02-28）

1. 打通 runtime 主链路：
- `packages/app/src/app/app.tsx` 的 `sendPrompt()` 已按 runtime 分流
- `claude-code` / `codex` 走 Tauri `agent_run_start`
- `opencode` 保持原 Session API 链路

2. 会话页新增本地 runtime 输出区：
- `packages/app/src/app/pages/session.tsx` 新增 `Local Runtime Output` 区块
- 允许在“无 OpenCode 消息回流”时仍看到 codex/claude 执行结果

3. 下线 router 活跃入口（默认链路）：
- `packages/app/src/app/components/status-bar.tsx` 移除 router 状态轮询
- `packages/desktop/src-tauri/src/commands/orchestrator.rs` 固定 `--no-opencode-router`
- `packages/desktop/scripts/prepare-sidecar.mjs` 忽略 router 构建请求

4. 瘦身工程化落地：
- 完善根 `.gitignore`（忽略 `target/sidecars` 等构建产物）
- 新增 `pnpm run clean:artifacts`（`scripts/clean-artifacts.mjs`）

5. 文档补齐：
- 新增 `packages/app/README.md`
- 新增 `packages/desktop/README.md`

6. Router 可选化收敛（默认不依赖、显式启用、缺失降级）：
- `packages/desktop/scripts/prepare-sidecar.mjs`：显式启用 router 时尝试构建；缺少 router 包/构建失败仅 warning，不再阻塞主链路
- `packages/orchestrator/src/cli.ts`：显式启用 router 但缺失 binary 时，未设置 `--opencode-router-required` 则自动降级并继续
- 新增执行记录：`plans/execution/03-router-optionalization.md`
- 同步 README 中 router 开关与降级说明
- 同步更新根 README 与 docs 中 router/安装路径说明

## 10. 实施记录（2026-02-28，Rebrand Baseline）

1. 完成仓库旧标识盘点基线：`openwork`、`@different-ai`、`OPENWORK_`、`opencode-router`、`router`。
2. 新增执行文档：`plans/execution/00-rebrand-baseline.md`。
3. 明确“必须保留功能”与“禁止误删区域”：session / proto / scheduled / soul / skills / extensions。
4. 输出后续 session 的 mapping、风险点与 ownership 分批建议。

## 11. 实施记录（2026-02-28，仓库整洁化收口）

1. 统一维护规则收口：
- 已在 `AGENTS.md` 增补统一维护规则（plans + README 联动、删除清单强制、不确定删除转 TODO）。

2. 计划与历史回填：
- 已同步回填 `plans/v0.6.md`、`plans/history.md`、`plans/v0.6-slimming-spec.md` 的收口记录与残留风险。

3. 仓库整洁化结论：
- 本次未执行物理删除（删除清单：空）。
- 原因：当前任务以“收口对齐与可执行校验”为主；存在不确定可删项时按规则保留并标注 TODO。

4. 可执行校验（CLI）：
- `pnpm -r typecheck`
- `pnpm -r lint`（如脚本存在）
- `pnpm -r test`（如脚本存在）

5. 风险残留（代码层）：
- `core/optional` 深度拆分尚未完成（app/server/orchestrator）。
- Router 虽已默认降级，但独立恢复链路仍缺少端到端自动化测试。
- 多平台（macOS/Linux）安装链路文档与验证尚未补齐。

## 12. 实施记录（2026-02-28，v0.7 Track 2 对齐）

1. 多助手并行状态模型（Rust/Tauri）：
- 新增 `packages/desktop/src-tauri/src/commands/runtimes.rs`。
- 新增并注册命令：
  - `check_assistant_statuses`
  - `check_opencode_status`
  - `check_claude_code_status`
  - `check_codex_status`
- 统一返回 `installed` / `loggedIn` / `version` / `details`，可供 Settings 页面直接消费。

2. Settings 控制器重构（前端接线）：
- `packages/app/src/app/pages/settings.tsx` 从单点 `check_runtime_available` 迁移到统一状态模型。
- Runtime 页面并列展示 OpenCode / Claude Code / Codex 的安装态与登录态，并支持一键刷新。
- `packages/app/src/app/lib/tauri.ts` 新增对应类型与调用封装。

3. 桌面端生命周期 Bug 修复：
- `packages/desktop/src-tauri/src/commands/agent_run.rs`
  - 新增 `abort_all_runs`，用于应用退出时清理本地 runtime 子进程。
  - 修复 run 结束事件固定 `exitCode=0` 的问题，改为上报真实退出码。
- `packages/desktop/src-tauri/src/lib.rs` 在退出回调中接入 `abort_all_runs`。

4. 解耦与兼容补强（DOWHAT 优先）：
- `packages/desktop/src-tauri/src/orchestrator/mod.rs`
  - 数据目录读取改为优先 `DOWHAT_DATA_DIR`，兼容 `OPENWORK_DATA_DIR`。
  - 默认目录迁移为 `.do-what/do-what-orchestrator`，并保留旧目录存在时的兼容回退。
- `packages/desktop/src-tauri/src/commands/engine.rs`
  - 启动关键 env 读取增加 `DOWHAT_*` 前缀兼容（bind host / auth / start timeout）。
- `packages/desktop/scripts/dev.mjs` 与 `packages/orchestrator/scripts/router.mjs`
  - 开发链路注入 `DOWHAT_DATA_DIR`（保留 `OPENWORK_DATA_DIR` 兼容）。

5. CLI 验证：
- `pnpm.cmd --filter @do-what/desktop exec cargo check --manifest-path src-tauri/Cargo.toml`（通过）
- `pnpm.cmd --filter @do-what/ui typecheck`（通过）

6. 文档联动：
- 更新 README：
  - `packages/desktop/README.md`
  - `packages/app/README.md`
  - `packages/orchestrator/README.md`
  - `packages/server/README.md`
- `plans/history.md` 已同步本次记录。
- `plans/v0.6-slimming-spec.md`：N/A（本次未发生结构瘦身/模块拆分）。

7. 删除动作：
- 删除清单：空
- 删除理由：本次仅做功能补强与兼容迁移，无物理删除需求。
- 验证命令：`git status --short`
