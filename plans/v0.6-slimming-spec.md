# v0.6 真瘦身 Spec（业务优先）

## 1. 目标定义

本轮瘦身只做一件事：先把“业务可运行”链路做成默认路径，桌面壳与扩展能力后置。

成功标准：
1. 新机器可在不依赖 Rust/Tauri 的前提下启动业务主流程。
2. 默认启动只包含会话业务核心，不加载实验页/扩展页/消息通道能力。
3. 项目结构可被快速理解，保留与裁剪边界明确。

非目标：
1. 不做 UI 视觉重构。
2. 不做品牌全量重命名。
3. 不在本轮处理所有历史技术债。

## 2. 现状盘点（按模块）

### 2.1 包级职责与保留结论

1. `packages/app`（保留，核心）
- 现状：业务 UI 主入口（会话、工作区、设置、技能、扩展、调度、soul、proto）。
- 结论：保留，但拆成 `core` 与 `optional` 两层，默认只开 core。

2. `packages/server`（保留，核心）
- 现状：工作区 API、权限/审批、opencode 代理、插件/MCP/技能/命令管理、toy-ui。
- 结论：保留核心 API；toy-ui 与扩展管理接口下沉为可选模块。

3. `packages/orchestrator`（保留，核心但需裁剪）
- 现状：负责拉起 opencode + openwork-server + 可选 router，文件体量大（`src/cli.ts`）。
- 结论：保留“业务编排最小集”，router 和 TUI 相关逻辑模块化为可选。

4. `packages/desktop`（暂缓，非核心）
- 现状：Tauri 桥接与 Rust 命令，安装和编译复杂度最高。
- 结论：从默认开发链路剥离，保持可选入口，不阻塞业务运行。

### 2.2 功能区块保留/裁剪矩阵

保留（v0.6 必需）：
1. 会话收发（Session/Composer/MessageList）。
2. 工作区切换与基础配置。
3. 模型与运行时最小设置。
4. openwork-server 与 opencode 健康状态展示（简版）。

可选关闭（v0.6 默认关闭）：
1. `proto-v1-ux`、`proto-workspaces`。
2. `scheduled`（调度页）。
3. `soul`（心跳与记忆页）。
4. `extensions` 中重功能入口（插件市场/复杂 MCP 向导）。
5. router 全链路（保持环境变量可开启）。
6. server `toy-ui`。

## 3. Spec 运行模式

新增“Spec 模式”定义（不是新产品形态，是瘦身开发模式）：

1. 默认模式：`business`
- 只启动业务最小链路（UI + orchestrator + openwork-server/opencode）。
- 不触发 Tauri 构建，不要求 Rust/linker 正常。

2. 可选模式：`desktop`
- 仅用于桌面壳联调与打包。
- 出错不影响业务开发节奏。

## 4. 分阶段实施计划

## Phase 0：基线清理（先减负再改逻辑）

范围：
1. 完整补齐 `.gitignore`（至少包含 `node_modules`、`dist`、`target`、临时产物、日志）。
2. 增加仓库清理命令（例如 `clean:artifacts`），清理 `src-tauri/target`、sidecar 临时产物。
3. 固化“源码体积统计”脚本，作为瘦身前后对比基线。

验收：
1. 仓库不再被构建产物污染。
2. 重新安装后目录体积可预测。

## Phase 1：启动链路改为业务优先

范围：
1. 根脚本改为三段式：
- `dev` -> `dev:business`
- `dev:business`（主入口）
- `dev:desktop`（保留）
2. 提供 `scripts/dev-business.*`，一键启动业务主链路。
3. 文档将桌面模式明确标注为“可选联调”。

验收：
1. 新人按一条命令可进入业务可用状态。
2. 桌面构建失败不影响主链路。

## Phase 2：应用层功能分层（Core/Optional）

范围：
1. `app` 中将路由与页面能力拆分为 `core` 与 `optional`。
2. 默认导航只显示：
- `sessions`
- `settings`（精简子项）
3. `scheduled/soul/extensions/proto` 通过特性开关控制。

验收：
1. 默认 UI 不再出现“非业务核心”入口。
2. 打开特性开关后可恢复原能力（不删功能，只隔离）。

## Phase 3：服务端与编排器去耦

范围：
1. `orchestrator` 把 router/TUI/高级诊断逻辑改为按需加载。
2. `server` 关闭 toy-ui 默认暴露，扩展接口放到可选注册段。
3. 统一环境开关命名与默认值（业务优先、router 默认关）。

验收：
1. 核心路径代码量显著下降（以入口文件职责和行数为准）。
2. 默认运行日志只包含业务核心服务。

## Phase 4：桌面壳隔离与回归

范围：
1. desktop 仅保留桥接核心命令，扩展命令按模块注册。
2. 将桌面失败排错与业务排错文档彻底分离。
3. 保留 `dev:desktop` 作为独立联调入口。

验收：
1. 用户不会把桌面错误误判为业务不可运行。
2. 桌面链路可单独维护，不绑主开发流。

## Phase 5：文档与计划维护

范围：
1. 同步更新：
- `README.md`
- `docs/STARTUP_GUIDE.md`
- `docs/CORE_LOGIC_AND_MODULES.md`
- `plans/v0.6.md`
- `plans/history.md`
2. 在 `AGENTS.md` 增补“core/optional 分层维护规则”。

验收：
1. 文档可直接指导新成员启动业务链路。
2. 计划与实际脚本一致。

## 5. 实施顺序建议

1. 先完成 Phase 0（立刻减负，成本最低）。
2. 再做 Phase 1（确保你马上能跑业务）。
3. 然后做 Phase 2（把 UI 中非核心入口关掉）。
4. 最后做 Phase 3/4（结构层瘦身与桌面隔离）。

## 6. 风险与回滚

风险：
1. 过快删除功能入口可能误伤已有流程。
2. 运行时开关过多会增加维护复杂度。

回滚策略：
1. 所有“瘦身”先以特性开关实现，不先物理删除。
2. `dev:desktop` 与原脚本保留一段过渡期。

## 7. 本 Spec 的落地产物（下一步）

下一轮实施必须至少交付：
1. 启动脚本：`dev:business`。
2. 功能开关：core/optional 首版。
3. `.gitignore` 与清理脚本。
4. 文档同步与计划回填。

## 8. 当前进度（2026-02-28）

已完成：
1. `.gitignore` 完善（含 `target/sidecars` 等构建产物）
2. 清理脚本落地：`pnpm run clean:artifacts`
3. runtime 发送主链路打通（codex/claude 实际可执行）
4. Session 页已可显示本地 runtime 输出
5. router 默认活跃入口已从 UI/desktop 主链路下线

待完成（下一步）：
1. `dev:business` 独立入口（目前仍以 `dev:lite` 命名）
2. app/server/orchestrator 的 core/optional 深度拆分

## 9. 收口约束补充（2026-02-28）

1. 删除治理规则：
- 不删除核心业务模块（session/proto/scheduled/soul/skills/extensions）。
- 删除动作必须附“删除清单 + 理由 + CLI 验证命令”。
- 不确定可删项一律保留并落 TODO。

2. 本次收口结论：
- 删除清单：无。
- 保留并 TODO：
  - TODO(core-split/2026-03): app/server/orchestrator 的 core/optional 深度拆分方案与迁移批次。
  - TODO(router-e2e/2026-03): router 显式启用路径的自动化回归用例。

3. 文档一致性：
- 规则源头以 `AGENTS.md` 为准；`plans/v0.6.md` 与 `plans/history.md` 必须同步记录同一批收口信息。
