# v0.2 执行记录（实际）

## 本轮完成内容（对应 v0.2-spec）

### 1) 运行时输出解析与结构化事件
- 新增 `packages/app/src/app/lib/agent-output-parser.ts`：
  - 定义 `RunEvent` union。
  - 实现 `parseClaudeCodeChunk()`（逐行 JSON 解析 + fallback 文本）。
  - 实现 `parseCodexChunk()`（bash/code block 正则识别 + 文本兜底）。
  - 实现 `OutputBuffer`（300ms debounce flush）。

### 2) Shared Config 抽象
- 新增 `packages/app/src/app/lib/shared-config.ts`：
  - `SharedConfig` / `McpEntry` 类型。
  - `readSharedConfig` / `writeSharedConfig`。
  - `readRulesContent` / `writeRulesContent`。
  - `buildPromptPrefix`（将 rules 注入前缀）。

### 3) Agent Run 视图组件
- 新增目录 `packages/app/src/app/components/agent-run/`，包含：
  - `index.tsx`
  - `text-card.tsx`
  - `tool-call-card.tsx`
  - `bash-card.tsx`
  - `file-write-card.tsx`
  - `code-card.tsx`
  - `error-card.tsx`
  - `done-banner.tsx`

### 4) App 侧 Agent Run 状态
- 修改 `packages/app/src/app/state/sessions.ts`：
  - 增加 `AgentRun` 相关类型（status/type/runtime/config）。
  - 增加 agentRuns store 与 `add/update/append` 方法。

### 5) Tauri 前端命令封装
- 修改 `packages/app/src/app/lib/tauri.ts`：
  - 新增 `agentRunStart()`。
  - 新增 `agentRunAbort()`。
  - 新增 `checkRuntimeAvailable()`。

### 6) Settings 增加 Runtimes 子页
- 修改 `packages/app/src/app/types.ts`：`SettingsTab` 增加 `"runtimes"`。
- 修改 `packages/app/src/app/pages/settings.tsx`：
  - tab 列表加入 `runtimes`。
  - 新增 Claude Code / Codex 状态卡片。
  - 接入 `checkRuntimeAvailable()` 检测版本。

### 7) Composer 运行时选择器（UI）
- 修改 `packages/app/src/app/components/session/composer.tsx`：
  - 底部操作区增加 runtime 下拉（OpenCode / Claude Code / Codex）。

### 8) Desktop 新增 agent run 命令
- 新增 `packages/desktop/src-tauri/src/commands/agent_run.rs`：
  - `agent_run_start`
  - `agent_run_abort`
  - `check_runtime_available`
  - `RunMap`
- 修改 `packages/desktop/src-tauri/src/commands/mod.rs`：注册 `agent_run` 模块。
- 修改 `packages/desktop/src-tauri/src/lib.rs`：
  - `manage(RunMap::default())`
  - 在 `invoke_handler` 中注册 3 个新命令。

## 未完成/后续（留到 v0.2 后续迭代）
- Sidebar 中 AgentRun 独立列表 + CC/CX badge 还未接入。
- Composer 的非 OpenCode 发送路径（真正调用 `agentRunStart` 并订阅事件）尚未贯通。
- Shared Config 当前以本地存储 + invoke 兜底，未完成完整桌面文件持久化命令配套。
- `AgentRunView` 组件已创建，但尚未挂到 session 主视图中。

## 验证
- 已执行：`pnpm --filter @different-ai/openwork-ui typecheck`（通过）
- 已执行：`pnpm typecheck`（通过）
- 已执行：`cargo check`（失败：当前环境访问 crates.io 返回 403，无法拉取依赖）

## 说明
- 由于当前环境网络限制，无法完成桌面端 Rust 命令的完整编译验证；前端类型检查已覆盖新增 TS/TSX 变更。
