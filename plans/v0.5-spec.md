# v0.5 — UI 重设计 执行规格

> 目标：暖米色调极简三栏布局，引擎/会话 tree 状态视图，清晰信息层级。
> 前提：v0.2-v0.4 功能已稳定。
> 完成标志：`pnpm dev:ui` 视觉效果符合 UI Style Bible；session DAG 组件可渲染。

---

## 详细设计规范

见同目录下 `ui-style-bible.md`。

---

## 新增文件

### A. `packages/app/src/app/styles/tokens.css`

Design token 文件，替代现有零散的 `--dls-*` 变量。

```css
:root {
  /* ---- Color: Background ---- */
  --color-bg-base:      #FAF8F5;   /* 主背景，暖白 */
  --color-bg-sidebar:   #F2EFE9;   /* 侧边栏背景 */
  --color-bg-elevated:  #FFFFFF;   /* 卡片、弹出层 */
  --color-bg-overlay:   rgba(0,0,0,0.04);

  /* ---- Color: Border ---- */
  --color-border-subtle:  #E5E0D8;
  --color-border-default: #D4CFC6;
  --color-border-strong:  #B8B2A8;

  /* ---- Color: Text ---- */
  --color-text-primary:   #1A1A1A;
  --color-text-secondary: #5C5750;
  --color-text-tertiary:  #8C887F;
  --color-text-disabled:  #B8B2A8;
  --color-text-inverse:   #FFFFFF;

  /* ---- Color: Accent ---- */
  --color-accent-primary:   #1A1A1A;  /* 极深灰替代蓝色 */
  --color-accent-secondary: #3D3A35;

  /* ---- Color: Status ---- */
  --color-status-success: var(--green-9);   /* Radix green */
  --color-status-warning: var(--amber-9);
  --color-status-error:   var(--red-9);
  --color-status-info:    var(--blue-9);

  /* ---- Color: Runtime Badge ---- */
  --color-runtime-cc-bg:   #FFF3E0;   /* Claude Code: 暖橙 */
  --color-runtime-cc-text: #E65100;
  --color-runtime-cx-bg:   #E8F5E9;   /* Codex: 暖绿 */
  --color-runtime-cx-text: #1B5E20;
  --color-runtime-oc-bg:   #EDE7F6;   /* OpenCode: 暖紫 */
  --color-runtime-oc-text: #4527A0;

  /* ---- Spacing ---- */
  --space-1: 4px;
  --space-2: 8px;
  --space-3: 12px;
  --space-4: 16px;
  --space-5: 20px;
  --space-6: 24px;
  --space-8: 32px;
  --space-10: 40px;

  /* ---- Radius ---- */
  --radius-sm:  4px;
  --radius-md:  8px;
  --radius-lg:  12px;
  --radius-xl:  16px;
  --radius-full: 9999px;

  /* ---- Typography ---- */
  --font-sans: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
  --font-mono: "JetBrains Mono", "Fira Code", monospace;
  --text-xs:   11px;
  --text-sm:   13px;
  --text-base: 14px;
  --text-lg:   16px;
  --text-xl:   18px;

  /* ---- Shadow ---- */
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
  --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
}
```

在 `packages/app/src/app/index.css` 顶部加入：
```css
@import "./styles/tokens.css";
```

---

### B. `packages/app/src/app/components/session-dag.tsx`

右上角项目 Session DAG 缩略图组件。

**Props**：
```ts
type Props = {
  projectId: string | null;
  onSelectSession: (id: string) => void;
};
```

**状态**：
```ts
const [expanded, setExpanded] = createSignal(false);
```

**折叠态**：
```tsx
// 只显示节点数量
<button
  onClick={() => setExpanded(true)}
  class="flex items-center gap-1 text-xs text-gray-10 border rounded px-2 py-1"
>
  <span>◆</span>
  <span>{sessionCount()} sessions</span>
</button>
```

**展开态**（浮层卡片，约 280×200px）：
```tsx
<div class="absolute top-10 right-0 w-[280px] h-[200px] border rounded-lg shadow-lg bg-white z-50 overflow-auto p-3">
  <div class="flex justify-between mb-2">
    <span class="text-sm font-medium">Session Flow</span>
    <button onClick={() => setExpanded(false)}>×</button>
  </div>
  {/* DAG 渲染：简单的垂直列表 + 连线（v0.5 用 CSS，v0.6 可用 dagre） */}
  <For each={dagNodes()}>
    {(node) => (
      <div
        class="flex items-center gap-2 p-1.5 rounded hover:bg-gray-2 cursor-pointer"
        onClick={() => props.onSelectSession(node.id)}
      >
        <span class={`w-2 h-2 rounded-full ${statusColor(node.status)}`} />
        <span class="text-xs flex-1 truncate">{node.title}</span>
        <RuntimeBadge runtime={node.runtime} />
      </div>
    )}
  </For>
</div>
```

**`dagNodes()` 计算逻辑**：
- 从 `projects` store 找到当前 project
- 合并 OpenCode sessions + AgentRuns
- 按 `startedAt` 排序
- 标注 `parentSessionIds` 的连接关系（v0.5 只显示列表，不画箭头）

---

## 修改已有文件

### C. `packages/app/src/app/index.css`

替换背景色变量，把现有的 gray 主色改为暖米色：

```css
/* 找到 :root 或 body 的背景设置，改为 */
body {
  background-color: var(--color-bg-base);
  color: var(--color-text-primary);
  font-family: var(--font-sans);
}
```

把现有的 `--dls-background-*` 等变量映射到新 token：
```css
/* 兼容层，让旧代码仍能工作 */
:root {
  --dls-background-1: var(--color-bg-base);
  --dls-background-2: var(--color-bg-sidebar);
  --dls-background-elevated: var(--color-bg-elevated);
}
```

### D. `packages/app/src/app/components/session/sidebar.tsx`

更新侧边栏背景色：
```tsx
// class 里把 bg-gray-1 / bg-white 等改为使用 token
<div class="bg-[var(--color-bg-sidebar)] border-r border-[var(--color-border-subtle)]">
```

### E. `packages/app/src/app/pages/session.tsx`

在主 session 视图右上角加入 `SessionDagWidget`：
```tsx
import SessionDagWidget from "../components/session-dag";

// 在 header 右侧加入
<SessionDagWidget
  projectId={activeProjectId()}
  onSelectSession={selectSession}
/>
```

---

## 验证检查清单

- [ ] `pnpm dev:ui` 启动，背景色为暖米色 (#FAF8F5)
- [ ] 侧边栏背景为 #F2EFE9
- [ ] 边框为 #E5E0D8 系列
- [ ] Session DAG 组件在 session 页面右上角可见
- [ ] 点击 DAG 组件展开，显示当前 project 的 session 列表
- [ ] `pnpm typecheck` 通过
