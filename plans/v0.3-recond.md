# v0.3 执行记录（实际）

## 本轮完成内容（对应 v0.3-spec）

### 1) Project 模型与 store（sessions.ts）
- 新增 `Project` 类型：`id/name/workdir/sessionIds/createdAt/lastActiveAt`。
- 新增 project store 与方法：
  - `useProjects()`
  - `createProject(name, workdir)`
  - `addSessionToProject(projectId, sessionId)`（带去重与 `lastActiveAt` 更新时间）
- 新增基于 localStorage 的持久化：`doWhat.projects`。
- 新增 `listAgentRunTextEvents(sessionIds, maxEvents)`，用于上下文摘要拼接。

### 2) 共享配置（shared-config.ts）
- 新增 `buildContextPrefix(parentSessionIds, { maxLength })`：
  - 从 `agentRuns` 中提取文本事件并拼接。
  - 默认截断到 1000 字符。
  - 输出格式为：
    - `--- Context from previous sessions ---`
    - `{summary}`
    - `--- End context ---`

### 3) Composer 增强（composer.tsx）
- 增加 Project 选择：
  - `No project`
  - 现有 project 列表
  - `+ New project`（弹窗输入 name/workdir）
- 增加前置 session 选择（在选中 project 后显示）：
  - 使用 project 下的 sessionId 列表。
  - 以可切换的 chip 形式多选。
- Draft 新增透传字段：
  - `runtime`
  - `projectId`
  - `parentSessionIds`

### 4) 发送链路注入上下文（app.tsx）
- 在 `sendPrompt` 中：
  - 根据 `draft.parentSessionIds` 调用 `buildContextPrefix()`。
  - 将前置摘要拼接到 prompt 前缀后再发送。
- 若 draft 携带 `projectId`，发送前调用 `addSessionToProject(projectId, sessionID)` 自动建立 project 关联。

### 5) Sidebar 按 Project 分组（sidebar.tsx）
- 在每个 workspace 下，将会话显示改为：
  - Project 分组块（显示 project 名）
  - `Quick Chats`（未归属 project 的会话）
- Project 分组支持折叠/展开。

## 验证
- 已执行：`pnpm typecheck`（通过）。

## 说明
- 当前实现里，前置 session 摘要来源于 `agentRuns` 文本事件；普通 OpenCode session 暂未做统一摘要抽取。
- `+ New project` 采用轻量 prompt 交互，后续可升级为统一 modal 流程。


## 与 v0.4 同步后的复测（本次补充）
- 已重新执行：`pnpm typecheck`（通过）。
- 已重新执行：`pnpm build:ui`（通过，存在 Vite chunk size 警告但不阻塞构建）。
- 已尝试执行：`pnpm test:sessions`（失败，环境缺少 `opencode` 可执行文件，报错 `spawn opencode ENOENT`）。

### 结论
- 当前 v0.3 改动在与现分支（含 v0.4 同步内容）下通过类型检查与前端生产构建。
- 端到端 session 脚本测试受当前环境依赖限制未完成。
