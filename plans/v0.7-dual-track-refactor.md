# v0.7-dual-track-refactor.md

基于当前项目的 6 大问题（界面汉化、核心逻辑无法启动、原有框架未解耦、图标未更新、参考 redesign-preview 的 UI 重构、平行化 AI 助手接入），我们制定了双轨并行的修改计划。

为了确保两个 AI session（Antigravity 与 Codex）在工作时互不干扰，本计划严格划分为两个线性、正交的轨道：
- **Track 1: 视觉与交互重构 (由 Antigravity 负责)** —— 侧重于前端页面 (`@do-what/ui` 等应用层前端源码)、CSS 变量及静态资产。
- **Track 2: 核心基座与逻辑解耦 (由 Codex 负责)** —— 侧重于后端 (`src-tauri` / Rust)、顶层配置文件（如 `package.json`, `Cargo.toml`）及核心的数据层鉴权抽象。

两人同时开工，分别占据不同的代码领地，最终在 UI 绑定数据时会合。

---

## Track 1: 视觉与体验重构 (Antigravity 专线)
**目标**：将应用全面汉化，替换遗留图标，并基于 `redesign-preview.html` 落地全新的现代 UI 布局，不涉及复杂的底层通信逻辑。

**工作目录焦点**：
- `packages/app/` 或 `packages/ui/` 等前端源码目录
- `svg-preview/` 参考目录
- `assets/` 静态资源目录

### 线性执行步骤：

#### Step 1: 视觉规范提取与新版 Layout 奠基
- **动作**：分析 `svg-preview/redesign-preview.html`。
- **目标**：在前端项目（`@do-what/ui` 或应用包）中提取并定义全新的 CSS Variables / Tailwind 颜色及排版规范。
- **验收**：建立全新的全局基础样式文件。

#### Step 2: 页面骨架重构
- **动作**：完全替换现有的前端主布局结构。
- **目标**：实现带有全新的侧边栏 (Sidebar)、顶部工具栏 (Toolbar) 以及主对话/任务流区域 (Main Area) 的静态骨架。
- **验收**：页面基本呈现 `redesign-preview.html` 的视觉效果。

#### Step 3: 图标与静态资产全面替换
- **动作**：清理和转移 `svg-preview/icons` 中的新图标。
- **目标**：清除所有旧的 `openwork`/`opencode` 徽标、应用图标，并将项目内所有按钮、菜单栏的矢量图标全部替换为新版 SVG。
- **验收**：界面上再无旧版痕迹，所有图标与新版 UI 风格匹配。

#### Step 4: 界面全面汉化 (i18n / 硬替换)
- **动作**：全局搜索前端源码中的硬编码英文。
- **目标**：将所有菜单、弹窗提示、按钮文本、占位符 (Placeholder) 等替换为中文。可以引入一层轻量级 i18n 字典，或直接硬编码替换。
- **验收**：前端界面 100% 中文化显示，且无布局溢出。

---

## Track 2: 核心基座与逻辑解耦 (Codex 专线)
**目标**：彻底剥离 openwork 历史包袱，修复桌面端生命周期 Bug，并完成“多 AI 助手平行接入”的底层数据模型抽象。

**工作目录焦点**：
- 根目录配置文件 (`package.json`, `opencode.json` 等)
- `packages/desktop/src-tauri/` (Rust 核心逻辑)
- 核心状态管理与进程通信代码 (前端服务层接口定义)

### 线性执行步骤：

#### Step 1: 依赖清理与彻底解耦
- **动作**：全局检索 `openwork` 或 `opencode` 引用的名称及特化逻辑。
- **目标**：在 `package.json`、`Cargo.toml`、打包脚本及基础模块中，移除不必要的依赖包袱，将借用的模块真正私有化沉淀为 `do-what` 专属通用模块。
- **验收**：项目可作为纯粹的 `do-what` 工作区顺利构建。

#### Step 2: 桌面端启动故障排查与修复
- **动作**：分析 Tauri 桌面端启动流程（`src-tauri/src/lib.rs` 及前端初始化对接）。
- **目标**：定位并修复所谓的“核心业务逻辑在启动桌面程序后不能正常运行”的问题。无论是进程间通信 (IPC) 失败、数据库连接异常还是初始状态机阻塞，将其打通。
- **验收**：使用 `pnpm tauri dev` 启动桌面端后，控制台无致命报错，前后端通信畅通。

#### Step 3: 多 AI 助手平行接入架构梳理（底层模型）
- **动作**：梳理目前仅支持单一助手的鉴权/对接模型。
- **目标**：改造底层状态设计，抽象出一套标准接口。允许系统能够通过扫描本地环境（甚至环境变量/二进制路径），*平行地* 探测电脑中是否安装了 `opencode`、`claude code` 和 `codex`。
- **验收**：数据层能够返回一个包涵可用助手列表及状态 (Installed/Not Installed, Logged In/Logged Out) 的响应数据结构。

#### Step 4: Settings 页面控制器重构
- **动作**：调整现有的“设置”逻辑抽象。
- **目标**：基于 Step 3 的抽象接口，将三种助手的检测、选择和登录逻辑平铺在同一层级去管理，为 Antigravity 随后制作的 UI 提供清晰的后端/状态机 API 支撑。
- **验收**：逻辑层的方法如 `checkOpencodeStatus`, `checkClaudeCodeStatus`, `checkCodexStatus` 可独立并列调用，无耦合。

---
**协同说明**：
在第一阶段（各自的 Step 1~3），双方的工作目录几乎零重叠；直到双方进入最后一步（如 UI 绑定新模型）时，按照 Codex 提供的抽象接口去接入 Antigravity 制定的 UI 即可。
