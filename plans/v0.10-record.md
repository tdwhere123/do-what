# v0.10 Record (Codex)

## 1. Scope
- 目标：落地 `plans/v0.10.md`，并按用户要求执行 Do-What hard-cut（不保留 OpenWork 兼容分支）。
- 重点：
  - 修复 `program not found`（Windows CLI 启动链路）。
  - 修复会话/导航 UI 问题（占位文案、损坏 Tailwind class、Skills 标签）。
  - 清空默认 Hub 源（不再内置 `openwork-hub`），保留外部安装与可配置 Hub 源。
  - 统一 env/header/flag 为 `DOWHAT_*` / `X-DoWhat-*` / `--dowhat-*`。

## 2. Implemented Changes

### 2.1 Runtime / Desktop
- `packages/desktop/src-tauri/src/commands/agent_run.rs`
  - 新增 runtime 候选可执行解析：
    - Claude: `claude`, `claude.cmd`, `claude-code`, `claude-code.cmd`
    - Codex: `codex`, `codex.cmd`
  - Windows 下对 `.cmd/.bat` 使用 `cmd /C` 执行，避免 `program not found`。
  - `agent_run_start` 与 `check_runtime_available` 统一使用同一套解析逻辑。

### 2.2 UI / App
- `packages/app/src/app/components/session/composer.tsx`
  - 占位文本：`询问 OpenWork...` -> `询问 do-what...`
  - 焦点事件名：`openwork:focusPrompt` -> `dowhat:focusPrompt`
  - inbox 路径：`.opencode/openwork/inbox/` -> `.opencode/dowhat/inbox/`
- `packages/app/src/app/pages/dashboard.tsx`
  - 修复损坏 class：`w - full ...` -> `w-full h-10 flex items-center ...`
- `packages/app/src/app/pages/skills.tsx`
  - `isOpenworkInjectedSkill` -> `isDowhatInjectedSkill`
  - 标签 `OpenWork` -> `do-what`
  - fallback 文案 `From openwork-hub` -> `From hub`
  - 分享文案更新为 do-what bundle / `share.dowhat.software`
- `packages/app/src/app/context/extensions.ts`
  - 删除默认 `different-ai/openwork-hub` 拉取。
  - 新增可配置 Hub 源：
    - `VITE_DOWHAT_HUB_OWNER`
    - `VITE_DOWHAT_HUB_REPO`
    - `VITE_DOWHAT_HUB_REF`（默认 `main`）
    - `VITE_DOWHAT_HUB_PATH`（默认 `skills`）
  - 未配置 Hub 时：返回空列表 + 非阻塞提示（可使用 Install from link）。

### 2.3 Server / Hub Default Clear
- `packages/server/src/skill-hub.ts`
  - 默认不再使用内置仓库。
  - 仅当设置 `DOWHAT_HUB_OWNER` + `DOWHAT_HUB_REPO` 时启用 Hub 读取/安装。
  - 未配置 Hub 时，`listHubSkills()` 返回空；安装时返回 `hub_source_not_configured`。
  - `User-Agent` branding 改为 `dowhat-server`。
- `packages/server/src/server.ts`
  - capabilities 中 `skills.source` 改为 `dowhat`。
  - capabilities 中 hub repo 元数据从 `DOWHAT_HUB_*` 读取，无配置则 `read/install=false`。
  - inbox/outbox 公布路径改为 `.opencode/dowhat/...`
  - header 使用 `X-DoWhat-*` / `x-dowhat-*`。
- `packages/server/src/types.ts`
  - `skills.source` 联合类型改为 `"dowhat" | "opencode"`。
- `packages/server/src/audit.ts`
  - 默认审计目录：`~/.do-what/do-what-server`
  - workspace 审计路径：`.opencode/dowhat/audit.jsonl`

### 2.4 Hard-Cut Compatibility Removal
- `packages/server/src/env-compat.ts`
- `packages/orchestrator/src/env-compat.ts`
- `packages/desktop/scripts/env-compat.mjs`
- `packages/desktop/src-tauri/src/commands/engine.rs` (`read_compat_env`)

以上兼容层全部改为“仅读取传入 key 对应环境变量”，不再做 `OPENWORK_*` -> `DOWHAT_*` 映射，也不再输出 deprecated 兼容提示。

### 2.5 Prefix / Protocol Unification
- 全仓关键变量、header、flag 已转为 `DOWHAT_*` / `X-DoWhat-*` / `--dowhat-*`。
- 典型示例：
  - `VITE_OPENWORK_URL` -> `VITE_DOWHAT_URL`
  - `OPENWORK_DOCKER_BIN` -> `DOWHAT_DOCKER_BIN`
  - `--openwork-host` -> `--dowhat-host`

## 3. 删除清单 + 删除理由 + 验证命令

### 3.1 删除清单
- 删除“默认 Hub 内置来源”逻辑（`different-ai/openwork-hub` 硬编码）。
- 删除 OpenWork 兼容 env 映射分支（server/orchestrator/desktop scripts）。
- 删除旧 header/flag 前缀接入（OpenWork 前缀）。
- 删除 startup preference 的 legacy key 读取（仅保留 `dowhat.startupPref`）。

### 3.2 删除理由
- 用户要求“兼容层直接去掉，全面 do-what”。
- 双前缀/双路径会增加维护复杂度并掩盖启动问题。
- Hub 默认空可降低外部依赖不稳定导致的干扰，保留外部安装路径即可满足扩展能力。

### 3.3 验证命令
```powershell
rg -n "OPENWORK_|X-OpenWork|x-openwork|--openwork-" packages --glob "!**/dist/**" --glob "!**/target/**" --glob "!**/gen/**"
rg -n "different-ai/openwork-hub|From openwork-hub|isOpenworkInjectedSkill|询问 OpenWork|w - full h - 10" packages/app
```

## 4. 结构瘦身 / 模块拆分记录
- 本次无新增模块拆分。
- 本次瘦身动作：
  - 去除 Hub 默认内置源依赖。
  - 去除 OpenWork env 兼容映射层。
  - 去除 startup preference legacy key 读取。

## 5. Verification Results
- Passed:
  - `pnpm --filter @do-what/ui typecheck`
  - `pnpm --filter @do-what/ui build`
  - `pnpm --filter @do-what/orchestrator typecheck`
  - `pnpm --filter @do-what/orchestrator build`
  - `pnpm --filter @do-what/server typecheck`
  - `pnpm --filter @do-what/server test`
  - `pnpm --filter @do-what/desktop exec cargo check --manifest-path src-tauri/Cargo.toml`

## 6. Notes
- `cargo check` 仍有一个既有警告（`commands/scheduler.rs` 未使用 import），不影响编译通过与主链路行为。
