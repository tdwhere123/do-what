# v0.1 — 清理基线 执行规格

> 目标：删除冗余模块，减少维护负担，保持最小可跑状态。
> 完成标志：`pnpm dev:ui` 无报错启动，`pnpm typecheck` 通过。

---

## 1. 删除自动更新模块

### 1.1 `packages/app/src/app/types.ts`

**删除**整个 `UpdateHandle` 类型定义（约 10 行）：

```ts
// 删除这整段
export type UpdateHandle = {
  available: boolean;
  currentVersion: string;
  version: string;
  date?: string;
  body?: string;
  rawJson: Record<string, unknown>;
  close: () => Promise<void>;
  download: (onEvent?: (event: any) => void) => Promise<void>;
  install: () => Promise<void>;
  downloadAndInstall: (onEvent?: (event: any) => void) => Promise<void>;
};
```

**修改** `DashboardTab` 类型，加入 `"sessions"`：

```ts
// 改前
export type DashboardTab =
  | "scheduled"
  | "soul"
  | "skills"
  | "extensions"
  | "settings";

// 改后
export type DashboardTab =
  | "sessions"
  | "scheduled"
  | "soul"
  | "skills"
  | "extensions"
  | "settings";
```

---

### 1.2 `packages/app/src/app/system-state.ts`

**删除** import 里的两行：
```ts
import { check } from "@tauri-apps/plugin-updater";
// 以及 types 导入中的：
  UpdateHandle,
```

**删除** 5 个信号（`createSignal` 调用）：
```ts
const [updateAutoCheck, setUpdateAutoCheck] = createSignal(true);
const [updateAutoDownload, setUpdateAutoDownload] = createSignal(false);
const [updateStatus, setUpdateStatus] = createSignal<any>(...);
const [pendingUpdate, setPendingUpdate] = createSignal<...>(null);
const [updateEnv, setUpdateEnv] = createSignal<...>(null);
```

**删除** 3 个函数（函数体 + 声明）：
- `checkForUpdates()`（约 40 行）
- `downloadUpdate()`（约 55 行）
- `installUpdateAndRestart()`（约 20 行）

**删除** return 对象里的所有 update 相关 key：
```ts
updateAutoCheck,
setUpdateAutoCheck,
updateAutoDownload,
setUpdateAutoDownload,
updateStatus,
setUpdateStatus,
pendingUpdate,
setPendingUpdate,
updateEnv,
setUpdateEnv,
checkForUpdates,
downloadUpdate,
installUpdateAndRestart,
```

---

### 1.3 `packages/app/src/app/app.tsx`

#### Import 段

**删除** types 导入里的 `UpdateHandle`：
```ts
// 删除这一行
  UpdateHandle,
```

**删除** tauri 导入里的 3 项：
```ts
// 删除这三行
  updaterEnvironment,
  opencodeRouterInfo,
  type OpenCodeRouterInfo,
```

#### Signal 声明段

**删除** 2 个信号：
```ts
const [opencodeRouterInfoState, setOpenCodeRouterInfoState] = createSignal<OpenCodeRouterInfo | null>(null);
const [launchUpdateCheckTriggered, setLaunchUpdateCheckTriggered] = createSignal(false);
```

#### systemState 解构段

**删除** 解构里的所有 update key（与 system-state.ts return 对应）：
```ts
updateAutoCheck,
setUpdateAutoCheck,
updateAutoDownload,
setUpdateAutoDownload,
updateStatus,
setUpdateStatus,
pendingUpdate,
setPendingUpdate,
updateEnv,
setUpdateEnv,
checkForUpdates,
downloadUpdate,
installUpdateAndRestart,
```

**删除** 解构后紧跟的 3 个常量/函数：
```ts
const UPDATE_AUTO_CHECK_EVERY_MS = 12 * 60 * 60_000;
const UPDATE_AUTO_CHECK_POLL_MS = 60_000;
const getUpdateLastCheckedAt = ...
const shouldAutoCheckForUpdates = ...
```

#### createEffect 段

**删除** 以下 effect 块（按功能描述定位，各自是独立的 `createEffect(() => { ... })` 块）：

1. **router info 轮询 effect**：包含 `opencodeRouterInfo()` 调用的 effect（约 20 行）
2. **updateAutoCheck 持久化**：`window.localStorage.setItem("openwork.updateAutoCheck", ...)` 的 effect
3. **updateAutoDownload 持久化**：`window.localStorage.setItem("openwork.updateAutoDownload", ...)` 的 effect
4. **updateStatus 持久化**：`window.localStorage.setItem("openwork.updateLastCheckedAt", ...)` 的 effect
5. **launch update check effect**：包含 `launchUpdateCheckTriggered()` 和 `checkForUpdates({ quiet: true })` 的 effect
6. **auto update check polling effect**：包含 `updateAutoCheck()` 和 `UPDATE_AUTO_CHECK_POLL_MS` 的 effect
7. **auto download effect**：包含 `updateAutoDownload()` 和 `downloadUpdate()` 的 effect

#### onMount 内部清理

在 `onMount` 里（`isTauriRuntime()` 分支内），**删除**：
```ts
// 删除：读取 updateAutoCheck localStorage
const storedUpdateAutoCheck = window.localStorage.getItem("openwork.updateAutoCheck");
if (storedUpdateAutoCheck === "0" || storedUpdateAutoCheck === "1") { ... }

// 删除：读取 updateAutoDownload localStorage
const storedUpdateAutoDownload = window.localStorage.getItem("openwork.updateAutoDownload");
if (storedUpdateAutoDownload === "0" || storedUpdateAutoDownload === "1") { ... }

// 删除：读取 updateLastCheckedAt localStorage
const storedUpdateCheckedAt = window.localStorage.getItem("openwork.updateLastCheckedAt");
if (storedUpdateCheckedAt) { ... }

// 删除：updaterEnvironment 调用
try {
  setUpdateEnv(await updaterEnvironment());
} catch { ... }

// 删除：launchUpdateCheckTriggered + checkForUpdates 块
if (!launchUpdateCheckTriggered()) {
  setLaunchUpdateCheckTriggered(true);
  checkForUpdates({ quiet: true }).catch(() => undefined);
}
```

#### Props 传递段（DashboardView / SessionView 的 props 对象）

**删除** 以下 props：
```ts
updateAutoCheck: updateAutoCheck(),
toggleUpdateAutoCheck: () => setUpdateAutoCheck(...),
updateAutoDownload: updateAutoDownload(),
toggleUpdateAutoDownload: () => setUpdateAutoDownload(...),
updateStatus: updateStatus(),
updateEnv: updateEnv(),
checkForUpdates: () => checkForUpdates(),
downloadUpdate: () => downloadUpdate(),
installUpdateAndRestart,
opencodeRouterInfo: opencodeRouterInfoState(),
```

---

### 1.4 `packages/desktop/src-tauri/src/commands/updater.rs`

如果文件存在，**整个文件删除**。并从 `mod.rs` 中删除对应的 `pub mod updater;` 声明。

---

## 2. 删除 OpenCode Router 模块

### 2.1 `packages/app/src/app/lib/openwork-server.ts`

**删除** `OpenworkServerCapabilities` 里的 `opencodeRouter` 字段：
```ts
// 改前
proxy?: { opencode: boolean; opencodeRouter: boolean };
// 改后
proxy?: { opencode: boolean };
```

**删除** 全部 `OpenworkOpenCodeRouter*` 类型定义（约 200 行），包括：
- `OpenworkOpenCodeRouterTelegramResult`
- `OpenworkOpenCodeRouterSlackResult`
- `OpenworkOpenCodeRouterTelegramBotInfo`
- `OpenworkOpenCodeRouterTelegramInfo`
- `OpenworkOpenCodeRouterTelegramEnabledResult`
- `OpenworkOpenCodeRouterHealthSnapshot`
- `OpenworkOpenCodeRouterBindingItem`
- `OpenworkOpenCodeRouterBindingsResult`
- `OpenworkOpenCodeRouterBindingUpdateResult`
- `OpenworkOpenCodeRouterSendResult`
- `OpenworkOpenCodeRouterIdentityItem`
- `OpenworkOpenCodeRouterTelegramIdentitiesResult`
- `OpenworkOpenCodeRouterSlackIdentitiesResult`
- `OpenworkOpenCodeRouterTelegramIdentityUpsertResult`
- `OpenworkOpenCodeRouterSlackIdentityUpsertResult`
- `OpenworkOpenCodeRouterTelegramIdentityDeleteResult`
- `OpenworkOpenCodeRouterSlackIdentityDeleteResult`

**删除** `timeouts` 对象里的：
```ts
opencodeRouter: 10_000,
```

**删除** client 返回对象里所有 router 方法（约 160 行）：
- `opencodeRouterHealth`
- `opencodeRouterBindings`
- `opencodeRouterTelegramIdentities`
- `opencodeRouterSlackIdentities`
- `setOpenCodeRouterTelegramToken`
- `setOpenCodeRouterSlackTokens`
- `getOpenCodeRouterTelegram`
- `getOpenCodeRouterTelegramIdentities`
- `upsertOpenCodeRouterTelegramIdentity`
- `deleteOpenCodeRouterTelegramIdentity`
- `getOpenCodeRouterSlackIdentities`
- `upsertOpenCodeRouterSlackIdentity`
- `deleteOpenCodeRouterSlackIdentity`
- `getOpenCodeRouterBindings`
- `setOpenCodeRouterBinding`
- `sendOpenCodeRouterMessage`
- `setOpenCodeRouterTelegramEnabled`

### 2.2 `packages/app/src/app/lib/tauri.ts`

**删除** `OpenCodeRouterInfo` 类型（如果存在）及 `opencodeRouterInfo` 函数（`invoke` 调用）。

### 2.3 `packages/desktop/src-tauri/src/commands/opencode_router.rs`

如果文件存在，**整个文件删除**。并从 `mod.rs` 中删除对应声明。

### 2.4 `packages/desktop/src-tauri/src/opencode_router/`

如果目录存在，**整个目录删除**。

---

## 3. Dashboard 合并 — 加入 sessions tab

### 3.1 `packages/app/src/app/pages/dashboard.tsx`

**新增** `sessions` tab 的 nav item，排在第一位：

```tsx
// 在 navItem 列表最前面加：
{navItem("sessions", "Sessions", <HistoryIcon />)}
// 使用已有的 History 或 MessageSquare lucide icon
```

**新增** Switch 里的 Match case（排在最前）：

```tsx
<Match when={props.tab === "sessions"}>
  {/* 复用现有 sidebar 的 session 列表逻辑，或直接渲染 WorkspaceSessionGroup */}
  <div class="flex flex-col gap-2 p-4">
    {/* session list placeholder — v0.2 会用 AgentRun 替换 */}
    <p class="text-sm text-gray-10">Sessions will appear here.</p>
  </div>
</Match>
```

**底部 nav** 里加入对应 tab 按钮（与其他 tab 按钮同样样式）。

---

## 4. 验证检查清单

Codex 完成后必须确认：

- [ ] `pnpm typecheck`（在 `packages/app` 目录下）通过，零错误
- [ ] `pnpm dev:ui` 启动，浏览器无红色 console 报错
- [ ] Dashboard 显示 6 个 tab：sessions / scheduled / soul / skills / extensions / settings
- [ ] 不存在任何对 `UpdateHandle`、`updaterEnvironment`、`opencodeRouterInfo`、`OpenCodeRouterInfo` 的引用
- [ ] 搜索 `@tauri-apps/plugin-updater`：结果为零
