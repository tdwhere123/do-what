# v0.4 执行记录（实际）

## 本轮完成内容（对应 v0.4-spec）

### 1) 新增两层记忆读写能力
- 新增 `packages/app/src/app/lib/memory.ts`：
  - `readSystemMemory` / `writeSystemMemory`（系统记忆 `system.md`）
  - `readProjectMemory` / `writeProjectMemory`（项目记忆 `AGENTS.md`）
  - `buildSystemMemoryPrefix`（截断到 500 chars）
- Web 环境增加 localStorage 兜底，Tauri 环境走 `invoke("read_text_file"|"write_text_file")`。

### 2) Prompt 前缀合并注入 system + rules
- 修改 `packages/app/src/app/lib/shared-config.ts`：
  - `buildPromptPrefix()` 从仅注入 rules 改为注入：
    - `<system_memory>...</system_memory>`
    - `<rules>...</rules>`

### 3) 新增记忆候选提取器
- 新增 `packages/app/src/app/lib/memory-extractor.ts`：
  - 定义 `MemoryCandidate`
  - 实现 `extractMemoryCandidates(run, options)`，规则版提取：
    - `file_write` 命中 `*.json/*.toml/*.yaml/*.yml` → project
    - `text` 命中关键词（记住/always/never/prefer）→ system
    - `done.durationMs > 30000` → system 提醒

### 4) 新增待记录状态仓库 + AgentRun 触发提取
- 新增 `packages/app/src/app/state/memory-candidates.ts`：
  - `useMemoryCandidates`
  - `addMemoryCandidates`
  - `dismissMemoryCandidate`
- 修改 `packages/app/src/app/state/sessions.ts`：
  - `AgentRun` 增加 `_memoryCandidatesExtracted` 运行时字段
  - 在 `updateAgentRun` / `appendRunEvent(done)` 时触发 `extractMemoryCandidates`
  - 将候选写入 `memory-candidates` store

### 5) Soul 页面重构为三段式编辑器
- 重写 `packages/app/src/app/pages/soul.tsx`：
  - 区块 1：关于你（system.md）
  - 区块 2：当前项目（项目切换 + AGENTS.md 编辑）
  - 区块 3：待记录（候选列表 + 写入/忽略）
- 修改 `packages/app/src/app/pages/dashboard.tsx`：
  - 为 SoulView 透传 `workspaces` 与 `activeWorkspaceId`，支持项目切换。

## 与 v0.3 可能冲突说明
- v0.3 若引入独立 Project store，本次 Soul 页当前使用 `workspaces` 作为项目来源。
- 后续可在不改记忆接口的前提下，将项目来源替换为 v0.3 的 Project store。

## 验证
- 已执行：`pnpm --filter @different-ai/openwork-ui typecheck`（通过）
- 已执行：`pnpm typecheck`（通过）

## 备注
- 本次提取逻辑保持规则化实现，未接入 AI 提取，符合 v0.4-spec 当前要求。
