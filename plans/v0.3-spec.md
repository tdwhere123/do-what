# v0.3 — 项目任务编排 执行规格

> 目标：给多个 session/run 加上关联关系（依赖/顺序），并用 Project 容器统一管理。
> 前提：v0.2 已完成（AgentRun 类型、侧边栏改造已就绪）。
> 完成标志：`pnpm typecheck` 通过；能创建 Project 并关联 sessions；侧边栏按 project 分组。

---

## 核心模型

```
Project（项目容器，对应一个 workdir）
  └── Session / AgentRun（叶节点，一个运行实例）
        parentSessionIds?: string[]   ← 依赖哪些 session 的上下文
        projectId?: string
```

**不新增独立 Task 抽象**，Session/AgentRun 本身就是任务单元。

---

## 修改 `packages/app/src/app/state/sessions.ts`

### 新增 `Project` 类型

```ts
export type Project = {
  id: string;
  name: string;
  workdir: string;
  sessionIds: string[];    // OpenCode session ID + AgentRun ID 混合
  createdAt: number;
  lastActiveAt: number;
};
```

### 在 `AgentRun` 类型上确认已有字段（v0.2 已加）：
```ts
projectId?: string;
parentSessionIds?: string[];
```

### 新增 Project store：

```ts
const [projects, setProjects] = createStore<Project[]>([]);

export function useProjects() {
  return { projects, setProjects };
}

export function createProject(name: string, workdir: string): Project {
  const project: Project = {
    id: crypto.randomUUID(),
    name,
    workdir,
    sessionIds: [],
    createdAt: Date.now(),
    lastActiveAt: Date.now(),
  };
  setProjects((p) => [project, ...p]);
  return project;
}

export function addSessionToProject(projectId: string, sessionId: string) {
  setProjects(
    (p) => p.id === projectId,
    (project) => ({
      ...project,
      sessionIds: [...project.sessionIds, sessionId],
      lastActiveAt: Date.now(),
    })
  );
}
```

### 持久化

用 `localStorage` 的 JSON 序列化即可（IndexedDB 留给 v0.5）：

```ts
// 启动时读取
const stored = localStorage.getItem("doWhat.projects");
if (stored) setProjects(JSON.parse(stored));

// 变化时写入
createEffect(() => {
  localStorage.setItem("doWhat.projects", JSON.stringify(projects));
});
```

---

## 修改 `packages/app/src/app/lib/shared-config.ts`

新增 `buildContextPrefix` 函数，在启动新 session 时自动注入父 session 摘要：

```ts
// 从 parentSessionIds 提取摘要，拼到 prompt 前缀
export async function buildContextPrefix(
  parentSessionIds: string[],
  options: { maxLength?: number }
): Promise<string> {
  if (!parentSessionIds.length) return "";

  // 查找 agentRuns store 里对应的 run
  // 取最后 N 个 events 里的 text 类型内容
  // 截断到 maxLength（默认 1000 chars）
  // 返回格式：
  // "--- Context from previous sessions ---\n{summary}\n--- End context ---\n\n"
  ...
}
```

---

## 修改 `packages/app/src/app/components/session/composer.tsx`

在 composer 里加入**两个可选字段**（不影响现有发送流程）：

1. **Project 选择器**（下拉）：
   - 列出所有 projects
   - 可选 "No project"（默认）
   - 可选 "+ New project"（弹出创建输入框）

2. **前置 session 选择器**（多选 combobox）：
   - 仅当选了某个 project 时显示
   - 列出该 project 内的所有 sessions/runs
   - 选中的 sessions 的摘要会被注入到 prompt 前缀

```tsx
const [selectedProjectId, setSelectedProjectId] = createSignal<string | null>(null);
const [parentSessionIds, setParentSessionIds] = createSignal<string[]>([]);
```

---

## 修改 `packages/app/src/app/components/session/sidebar.tsx`

按 Project 分组显示 sessions：

```tsx
// 结构：
// [Project A] ▼
//   ├── [CC] session 1
//   ├── [CX] session 2
// [Project B] ▼
//   └── ...
// [Quick Chats] ▼  (无 project 的)
//   └── ...
```

每个 project 分组：
- 显示 project name + workdir 路径（截断）
- 可折叠（`createSignal<boolean>(true)`）
- 点击 project 名：展开/收起
- 右键或 `...` 菜单：重命名 / 删除（v0.4 完善）

---

## 验证检查清单

- [ ] `pnpm typecheck` 通过
- [ ] 能创建 Project，刷新后 project 仍存在（localStorage 持久化）
- [ ] Composer 显示 project 选择器，选了 project 后显示前置 session 选择器
- [ ] 选前置 session 后，其摘要出现在 prompt 前缀里（console.log 验证即可）
- [ ] 侧边栏按 project 分组，可折叠
- [ ] 无 project 的 sessions 归入 "Quick Chats" 组
